#!/usr/bin/env bash

REFERENCES_FOLDER="$HOME/src/zotero-notes-export"
NOTES_FOLDER="$HOME/notes"

tmpfile=$(mktemp /tmp/update-references.XXXXXX)
echo "tmpfile: $tmpfile"

error_and_quit() {
    message="$1"
    >&2 echo "$message"
    exit -1
}

cd "$REFERENCES_FOLDER"

git add --all || error_and_quit "Failed git add --all"
git commit -m "[content] $(date -u '+%F %T UTC')" \
    || error_and_quit "Failed git commit"

git diff "head~" "head"> "$tmpfile"


cd "$NOTES_FOLDER"

gstatus=$(git status --porcelain)

if [ ${#gstatus} -ne 0 ] ; then
    git add --all || error_and_quit "Failed git add --all"
    git commit -m "[content] $(date -u '+%F %T UTC')" \
        || error_and_quit "Failed git commit"
fi

git apply "$tmpfile" || error_and_quit "Failed git apply"

gstatus=$(git status --porcelain)

if [ ${#gstatus} -ne 0 ] ; then
    git add --all || error_and_quit "Failed git add --all"
    git commit -m "[references] $(date -u '+%F %T UTC')" \
        || error_and_quit "Failed git commit"
fi
