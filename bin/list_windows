#!/usr/bin/env bash
# ftwind - switch window (based on @george-b)
GREEN='\033[00;32m'
RESTORE='\033[0m'

delim=$'\t'

# From https://stackoverflow.com/a/17841619
function join_by { local d=$1; shift; echo -n "$1"; shift; printf "%s" "${@/#/$d}"; }

display_all=false
list_windows_options=''
window_sort_format="#{session_last_attached}$delim#S$delim#{window_stack_index}"
window_active_format="#{session_attached}$delim#{window_active}"
window_display_format="#{pane_current_path}$delim#{window_name}"
window_id_format="#S$delim#I"
switch_command="select-window"

if [ "$#" -ge 2 ]; then
    echo "Too many arguments"
    exit -1
fi

if [ "$#" -eq 1 ]; then
    if [ "$1" == "-a" ]; then
        display_all=true
        list_windows_options='-a'
        switch_command="switch-client"
    else
        echo "Unexpected argument \"$1\""
        exit -1
    fi
    shift
fi

reformat_windows() {
    while IFS=$delim read session_active window_active session_name window_num path name; do
        dir_name=$(basename "$path")

        # Change color if active
        # We surround what we want colored with a pair of '+' characters, so that
        # the column command doesn't get confused.  Note that there will always be
        # 2 '+' characters so width is always the same.
        # Later on, we will use sed to replace the '+' characters with color escape
        # sequences
        if [ "$display_all" = true ] ; then
            if [ "$session_active" = "1" ]; then
                if [ "$window_active" = "1" ]; then
                    target_window="+$session_name:$window_num+"
                else
                    target_window="+$session_name+:$window_num"
                fi
            else
                target_window="++$session_name:$window_num"
            fi
        else
            if [ "$window_active" = "1" ]; then
                target_window="+$window_num+"
            else
                target_window="++$window_num"
            fi
        fi

        # Create output line
        echo "$target_window$delim$dir_name$delim$name"
    done
}

# Align on columns and perform coloring
windows=$(
    tmux list-windows $list_windows_options -F \
    "$window_sort_format$delim$window_active_format$delim$window_id_format$delim$window_display_format" \
    | sort -t "$delim" -k 1,1nr -k 2,2 -k 3,3n \
    | cut -d "$delim" -f 4- \
    | reformat_windows \
    | column -s $'\t' -t \
    | sed "s/+\(.*\)+/$(printf "$GREEN")\1$(printf "$RESTORE")/g"
)

echo "$windows"
